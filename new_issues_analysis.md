# 新问题分析报告

## 问题概述

用户反馈 v2.3 版本仍存在两个主要问题：

1. **未依照排班偏好来排班**
2. **假日、夜班（小夜、大夜分开计）不平均**

## 详细分析

### 问题 1：偏好满足度不足

#### 现象
从截图中可以看到员工的偏好标记（心形图标和字母），但排班结果可能没有充分满足这些偏好。

#### 根本原因

在 v2.3 中，我们为了提升公平性，引入了"动态偏好放宽"机制：

```javascript
// 如果落后平均值 3 天以上，开放所有班别选项
if (currentOff < expectedOff - 3) {
    list = ['D', 'E', 'N', 'OFF'];
}
```

**问题**：这个机制在提升公平性的同时，**过度牺牲了偏好满足度**。

#### 影响
- 员工提交的偏好被忽略
- 满意度下降
- 违背了策略 B（愿望优先）的设计初衷

### 问题 2：假日和夜班分配不平均

#### 现象分析

从截图统计列可以看到：

| 员工 | 假日 | 小夜 | 大夜 | 问题 |
|------|------|------|------|------|
| 郭力宣 | 5 | 12 | 0 | 大夜为 0 |
| 林珈琪 | 3 | 15 | 2 | 小夜过多 (15) |
| 廖攸凯 | 6 | 4 | 15 | 大夜过多 (15) |
| 高郁惠 | 4 | 2 | 11 | 大夜过多 (11) |
| 简嘉堂 | 6 | 1 | 0 | 大夜为 0，小夜过少 |

**极端差异**：
- 小夜：0-15 天（差距 15 天）
- 大夜：0-15 天（差距 15 天）

#### 根本原因

v2.3 的 `balanceShiftTypes` 函数存在以下问题：

1. **只交换工作日之间的班次**
   ```javascript
   // 只交换工作日，不涉及 OFF
   if (!['D','E','N'].includes(theirShift)) continue;
   ```
   这导致如果某人已经被分配了很多 N 班，只能跟其他工作日交换，无法根本性地减少 N 班数量。

2. **交换条件过于严格**
   需要双向都满足 `canSwap` 条件，实际可交换的机会很少。

3. **没有区分假日班次**
   算法没有单独追踪和平衡假日（周六日）的班次分配。

4. **处理范围有限**
   只处理前后 30% 的极端值，对于中间的不平衡无能为力。

## 核心矛盾

**公平性 vs 满意度的权衡**：

- v2.2：偏好满足度高，但公平性差（OFF 差距 20+ 天）
- v2.3：公平性提升（OFF 差距缩小），但偏好满足度下降

**目标**：找到平衡点，在保证基本公平的前提下，最大化偏好满足度。

## 改进方向

### 1. 优化偏好满足机制

#### 方案 A：分阶段策略
- **阶段 1（前 70% 天数）**：严格遵守偏好
- **阶段 2（后 30% 天数）**：根据平衡度动态调整

#### 方案 B：软约束
- 将偏好作为"软约束"而非"硬约束"
- 在平衡算法中加入"偏好违背惩罚"
- 优先交换不符合偏好的班次

#### 方案 C：偏好优先级
- 区分"强偏好"和"弱偏好"
- 强偏好（priority1）始终遵守
- 弱偏好（priority2）可以在必要时放宽

**推荐**：方案 C，既保证核心偏好，又保留平衡空间。

### 2. 增强班次类型平衡

#### 改进 1：独立追踪 E 和 N
当前 `balanceShiftTypes` 对 D/E/N 一视同仁，但实际上：
- **E（小夜）** 和 **N（大夜）** 是完全不同的班次
- 应该分别计算标准差和平衡

#### 改进 2：支持 OFF 与工作日交换
允许将过多的 N 班转换为 OFF，然后让 N 班少的人填补。

#### 改进 3：假日班次单独平衡
- 追踪每个员工在周六、周日的班次数量
- 确保假日工作负担均衡

#### 改进 4：多轮专项平衡
```javascript
enhancedGlobalBalance() {
    // 第 1 步：平衡 OFF 总数
    balanceOFF();
    
    // 第 2 步：平衡小夜班（E）
    balanceShiftType('E');
    
    // 第 3 步：平衡大夜班（N）
    balanceShiftType('N');
    
    // 第 4 步：平衡假日班次
    balanceWeekendShifts();
    
    // 第 5 步：优化偏好满足度
    optimizePreferences();
}
```

### 3. 评分机制调整

当前策略 A 的权重：
```javascript
A: {
    overwork: -200,
    shiftBalance: -150,
    pref: 100,  // 偏好权重较低
    cons: -100,
    nToD: -150,
    coverage: 50,
}
```

**建议**：提升偏好权重到 150-200，与公平性权重相当。

## 实施计划

### 优先级 1：增强班次类型平衡（解决问题 2）
- 分别平衡 E 和 N 班
- 追踪假日班次
- 支持更灵活的交换策略

### 优先级 2：优化偏好满足（解决问题 1）
- 实施"偏好优先级"机制
- 在平衡过程中优先保留符合偏好的班次
- 添加偏好满足度监控

### 优先级 3：参数可配置化
- 将阈值（3 天、1.5 标准差、40%）改为可配置参数
- 根据策略（A/B/C）动态调整

## 预期效果

### 问题 1 改进
- 偏好满足度从当前的 ?% 提升到 70%+
- priority1 偏好满足率达到 90%+

### 问题 2 改进
- 小夜班标准差从当前的 ~5 天降低到 < 2 天
- 大夜班标准差从当前的 ~5 天降低到 < 2 天
- 假日班次标准差 < 1.5 天

### 整体平衡
- 保持 OFF 标准差 < 2 天
- 偏好满足度和公平性达到更好的平衡
